FROM timescale/timescaledb:latest-pg14

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½é·ç§»æ–‡ä»¶
COPY migrations/*.sql /app/migrations/

# æ·»åŠ  TimescaleDB é…ç½®ï¼Œå•Ÿç”¨job schedulingåŠŸèƒ½
RUN echo "# TimescaleDB é…ç½®" > /etc/postgresql-custom.conf \
    && echo "shared_preload_libraries = 'timescaledb'" >> /etc/postgresql-custom.conf \
    && echo "timescaledb.max_background_workers = 16" >> /etc/postgresql-custom.conf \
    && echo "track_io_timing = on" >> /etc/postgresql-custom.conf \
    && echo "max_worker_processes = 32" >> /etc/postgresql-custom.conf \
    && echo "max_parallel_workers = 16" >> /etc/postgresql-custom.conf \
    && echo "max_parallel_workers_per_gather = 8" >> /etc/postgresql-custom.conf \
    && echo "work_mem = '64MB'" >> /etc/postgresql-custom.conf

# å‰µå»ºé…ç½®åŠ è¼‰è…³æœ¬
RUN echo '#!/bin/bash' > /docker-entrypoint-initdb.d/000_load_custom_config.sh \
    && echo 'set -e' >> /docker-entrypoint-initdb.d/000_load_custom_config.sh \
    && echo 'echo "è¼‰å…¥è‡ªå®šç¾© PostgreSQL é…ç½®..."' >> /docker-entrypoint-initdb.d/000_load_custom_config.sh \
    && echo 'cat /etc/postgresql-custom.conf >> /var/lib/postgresql/data/postgresql.conf' >> /docker-entrypoint-initdb.d/000_load_custom_config.sh \
    && echo 'echo "âœ… è‡ªå®šç¾©é…ç½®å·²è¼‰å…¥"' >> /docker-entrypoint-initdb.d/000_load_custom_config.sh \
    && chmod +x /docker-entrypoint-initdb.d/000_load_custom_config.sh

# å‰µå»ºè¼”åŠ©SQLæ–‡ä»¶ï¼Œé¿å…è¤‡é›œçš„å¼•è™ŸåµŒå¥—
RUN echo '  CREATE OR REPLACE FUNCTION run_sql_command(config JSONB)' > /tmp/sql_functions.sql \
    && echo '  RETURNS VOID AS \$\$' >> /tmp/sql_functions.sql \
    && echo '  BEGIN' >> /tmp/sql_functions.sql \
    && echo '      EXECUTE (config->>''sql_text'');' >> /tmp/sql_functions.sql \
    && echo '  END \$\$ LANGUAGE plpgsql;' >> /tmp/sql_functions.sql \
    && echo '' >> /tmp/sql_functions.sql \
    && echo '  -- å»ºç«‹é€šç”¨å‡½æ•¸ä¾†å‰µå»ºèª¿åº¦ä»»å‹™' >> /tmp/sql_functions.sql \
    && echo '  CREATE OR REPLACE FUNCTION create_job_if_not_exists(' >> /tmp/sql_functions.sql \
    && echo '    job_name TEXT, ' >> /tmp/sql_functions.sql \
    && echo '    schedule_interval INTERVAL, ' >> /tmp/sql_functions.sql \
    && echo '    sql_command TEXT' >> /tmp/sql_functions.sql \
    && echo '  ) RETURNS BOOLEAN AS \$\$' >> /tmp/sql_functions.sql \
    && echo '  DECLARE' >> /tmp/sql_functions.sql \
    && echo '    job_id INTEGER;' >> /tmp/sql_functions.sql \
    && echo '  BEGIN' >> /tmp/sql_functions.sql \
    && echo '    SELECT j.job_id INTO job_id FROM timescaledb_information.jobs j' >> /tmp/sql_functions.sql \
    && echo '    WHERE jsonb_extract_path_text(j.config, ''job_name'') = job_name;' >> /tmp/sql_functions.sql \
    && echo '' >> /tmp/sql_functions.sql \
    && echo '    IF job_id IS NULL THEN' >> /tmp/sql_functions.sql \
    && echo '      SELECT add_job(' >> /tmp/sql_functions.sql \
    && echo '        ''run_sql_command'',' >> /tmp/sql_functions.sql \
    && echo '        schedule_interval,' >> /tmp/sql_functions.sql \
    && echo '        jsonb_build_object(''sql_text'', sql_command, ''job_name'', job_name),' >> /tmp/sql_functions.sql \
    && echo '        now()' >> /tmp/sql_functions.sql \
    && echo '      ) INTO job_id;' >> /tmp/sql_functions.sql \
    && echo '      RETURN TRUE;' >> /tmp/sql_functions.sql \
    && echo '    ELSE' >> /tmp/sql_functions.sql \
    && echo '      RETURN FALSE;' >> /tmp/sql_functions.sql \
    && echo '    END IF;' >> /tmp/sql_functions.sql \
    && echo '  END;' >> /tmp/sql_functions.sql \
    && echo '  \$\$ LANGUAGE plpgsql;' >> /tmp/sql_functions.sql

# å‰µå»ºåˆå§‹åŒ–è…³æœ¬
RUN echo '#!/bin/bash' > /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo 'set -e' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo 'echo "å‰µå»ºå¿…è¦çš„æ“´å±•..."' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo 'psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo '  CREATE EXTENSION IF NOT EXISTS timescaledb;' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo '  -- è¨­ç½®TimescaleDBä½œæ¥­èª¿åº¦ç³»çµ±' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo '  CREATE SCHEMA IF NOT EXISTS timescaledb_jobs;' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo '  -- å‰µå»ºç”¨æ–¼åŸ·è¡Œä»»æ„SQLå‘½ä»¤çš„è¼”åŠ©å‡½æ•¸' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && cat /tmp/sql_functions.sql >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo 'EOSQL' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && echo 'echo "âœ… å¿…è¦çš„æ“´å±•å·²å‰µå»º"' >> /docker-entrypoint-initdb.d/001_setup_extensions.sh \
    && chmod +x /docker-entrypoint-initdb.d/001_setup_extensions.sh

# å‰µå»ºSQLé·ç§»è…³æœ¬
RUN echo '#!/bin/bash' > /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'set -e' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'echo "===== é–‹å§‹åŸ·è¡Œæ•¸æ“šåº«é·ç§» ====="' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'cd /app/migrations' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'for migration in $(ls -v *.sql 2>/dev/null)' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'do' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '  echo "ðŸ”„ åŸ·è¡Œé·ç§»: $migration"' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '  psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" -f "$migration"' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '  if [ $? -ne 0 ]; then' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '    echo "âŒ é·ç§» $migration å¤±æ•—"' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '    exit 1' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo '  fi' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'done' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'echo "âœ… æ•¸æ“šåº«é·ç§»å®Œæˆ"' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && echo 'echo "===== é·ç§»ç¨‹åºçµæŸ ====="' >> /docker-entrypoint-initdb.d/002_run_migrations.sh \
    && chmod +x /docker-entrypoint-initdb.d/002_run_migrations.sh 